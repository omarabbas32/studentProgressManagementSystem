<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Questions</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="std_questions.css">
</head>
<body>
  <div class="container">
    <h1>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h1>

    <form id="addEditForm">
      <label for="page_number">Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©:</label>
      <input type="text" id="page_number" name="page_number" required />

      <label for="question_number">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
      <input type="text" id="question_number" name="question_number" required />

      <label for="book_name">Ø§Ù„ÙƒØªØ§Ø¨:</label>
      <textarea id="book_name" name="book_name" required></textarea>

      <button type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
    </form>

    <hr />

    <div id="questionsTable">
      <h2>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
      <table id="questionsList">
        <thead>
          <tr>
            <th>Ø§Ù„ÙƒØªØ§Ø¨</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          <!-- Questions will appear here -->
        </tbody>
      </table>
    </div>

    <button id="finishLevelBtn" class="finish-level-btn">
      Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙŠ
    </button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const baseUrl = "http://localhost:5000";
      const studentId = localStorage.getItem('studentId');
      const thisweekchapter = localStorage.getItem('thisweekchapter');
      const level = localStorage.getItem('theLevel'); // Using theLevel from localStorage
      const nextLevel = parseInt(level) + 1; // Calculate next level

      if (!studentId || !thisweekchapter || !level) {
        alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©');
        return;
      }
  
      document.getElementById("addEditForm").addEventListener("submit", function (e) {
        e.preventDefault();  // Prevent the default form submission
  
        const page = parseInt(document.getElementById("page_number").value);
        const questionNumber = parseInt(document.getElementById("question_number").value);
        const bookName = document.getElementById("book_name").value.trim();
  
        if (!page || !questionNumber || !bookName) {
          alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
          return;
        }
  
        // Try new system first (POST /api/problems)
        const problem = {
          book: bookName,
          page: page,
          numberOfProblem: questionNumber,
          level: parseInt(level),
          chapter: parseInt(thisweekchapter)
        };

        fetch(`${baseUrl}/api/problems`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(problem),
        })
          .then(response => {
            if (!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø©");
            return response.json();
          })
          .then(data => {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨.');
            fetchQuestions(); // Refresh the list
            document.getElementById("addEditForm").reset();
          })
          .catch(error => {
            console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø©:', error);
            // Fallback to old system
            const oldProblem = {
              studentId: studentId,
              chapterIndex: parseInt(thisweekchapter),
              levelIndex: parseInt(level),
              book: bookName,
              page: page,
              numberOfQuestion: questionNumber
            };
            fetch(`${baseUrl}/api/Students/add-problem`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(oldProblem),
            })
              .then(response => {
                if (!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø©");
                return response.json();
              })
              .then(data => {
                alert('ØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                fetchQuestions();
                document.getElementById("addEditForm").reset();
              })
              .catch(err => {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message);
              });
          });
      });
  
      function fetchQuestions() {
        // Try new system first (GET /api/Students/:id/problems)
        fetch(`${baseUrl}/api/Students/${studentId}/problems`)
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            // Filter problems by chapter and level - show ALL problems (solved and remaining)
            const filteredProblems = data.problems.filter(p => 
              parseInt(p.chapter) === parseInt(thisweekchapter) && 
              parseInt(p.level) === parseInt(level)
            );
            
            // Sort: show remaining problems first, then solved ones
            filteredProblems.sort((a, b) => {
              if (a.isSolved === b.isSolved) return 0;
              return a.isSolved ? 1 : -1; // remaining first
            });
            
            // Show level completion status if all problems are solved
            const allSolved = filteredProblems.length > 0 && filteredProblems.every(p => p.isSolved);
            if (allSolved && filteredProblems.length > 0) {
              const levelCompletionMsg = document.createElement('div');
              levelCompletionMsg.className = 'level-completed';
              levelCompletionMsg.innerHTML = '<strong>âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰!</strong>';
              document.querySelector("#questionsTable").insertBefore(levelCompletionMsg, document.querySelector("#questionsTable h2"));
              setTimeout(() => levelCompletionMsg.remove(), 5000);
            }
            
            renderQuestions(filteredProblems);
          })
          .catch(error => {
            console.error("Error fetching questions:", error);
            // Fallback to old system
            fetch(`${baseUrl}/api/Students/problems/${studentId}/${thisweekchapter}/${level}`)
              .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
              })
              .then(data => renderQuestions(data))
              .catch(err => {
                document.querySelector("#questionsList tbody").innerHTML = `
                  <tr>
                    <td colspan="5" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td>
                  </tr>
                `;
              });
          });
      }
  
      function renderQuestions(questions) {
        const questionsTable = document.querySelector("#questionsList tbody");
        questionsTable.innerHTML = questions?.length ? "" : `
          <tr>
            <td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©</td>
          </tr>
        `;

        questions?.forEach(question => {
          const row = document.createElement("tr");
          const isSolved = question.isSolved || false;
          const statusClass = isSolved ? 'solved' : 'remaining';
          const statusText = isSolved ? 'âœ… ØªÙ… Ø§Ù„Ø­Ù„' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø­Ù„';
          
          row.innerHTML = `
            <td>${question.book || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>${question.page || '--'}</td>
            <td>${question.numberOfProblem || '--'}</td>
            <td class="status ${statusClass}">${statusText}</td>
            <td class="actions">
              ${!isSolved ? `<button class="solve-btn" data-id="${question.problemId}"><i class="fas fa-check"></i> Ø­Ù„</button>` : '<span style="color: green;">âœ“ ØªÙ… Ø§Ù„Ø­Ù„</span>'}
              <button class="delete" data-id="${question.problemId}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
            </td>
          `;
          questionsTable.appendChild(row);
        });

        // Add solve button handlers
        document.querySelectorAll(".solve-btn").forEach(btn => {
          btn.addEventListener("click", function (e) {
            const problemId = e.target.closest('button').getAttribute('data-id');
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
              fetch(`${baseUrl}/api/Students/${studentId}/solve/${problemId}`, {
                method: 'PUT'
              })
                .then(response => {
                  if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„');
                  return response.json();
                })
                .then(data => {
                  alert('ØªÙ… Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¢Ù† ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ù„ÙˆÙ„Ø©');
                  if (data.student.levelCompleted) {
                    alert('Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰! ğŸ‰');
                  }
                  fetchQuestions(); // Refresh the list - will show solved problem with different status
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„: ' + error.message);
                });
            }
          });
        });

        document.querySelectorAll(".delete").forEach(btn => {
          btn.addEventListener("click", function (e) {
            const problemId = e.target.closest('button').getAttribute('data-id');
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ')) {
              fetch(`${baseUrl}/api/Students/${studentId}/problem/${problemId}`, {
                method: 'DELETE'
              })
                .then(response => {
                  if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„');
                  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                  fetchQuestions(); // Refresh the list
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + error.message);
                });
            }
          });
        });
      }
  
      document.getElementById("finishLevelBtn").addEventListener("click", async function () {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) return;
        
        try {
          // First API call - Delete the current level
          const deleteResponse = await fetch(`${baseUrl}/api/Students/problems/${studentId}/${thisweekchapter}/${level}`, { // Using theLevel here
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
          });
          
          // Second API call - Save the new level (nextLevel)
          const saveResponse = await fetch(`${baseUrl}/api/UpdatingLevel/save-level`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              studentId: parseInt(studentId),
              chapterId: parseInt(thisweekchapter),
              newLevel: nextLevel // Using the calculated nextLevel
            })
          });
          
          if (!saveResponse.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯');
          
          // Update localStorage with the new level
          localStorage.setItem('theLevel', nextLevel.toString());
          
          // Success message
          alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
          window.location.reload();
        } catch (error) {
          console.error('Error:', error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        }
      });
     
      fetchQuestions();
    });
  </script>
</body>
</html>