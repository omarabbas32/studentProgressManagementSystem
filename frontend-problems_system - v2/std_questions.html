<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Questions</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="std_questions.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="container">
    <h1>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h1>

    <form id="addEditForm">
      <label for="page_number">Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©:</label>
      <input type="text" id="page_number" name="page_number" required />

      <label for="question_number">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
      <input type="text" id="question_number" name="question_number" required />

      <label for="book_name">Ø§Ù„ÙƒØªØ§Ø¨:</label>
      <textarea id="book_name" name="book_name" required></textarea>

      <button type="submit" id="submitBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
    </form>

    <hr />

    <div id="questionsTable">
      <h2>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
      <table id="questionsList">
        <thead>
          <tr>
            <th>Ø§Ù„ÙƒØªØ§Ø¨</th>
            <th>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          <!-- Questions will appear here -->
        </tbody>
      </table>
    </div>

    <button id="finishLevelBtn" class="finish-level-btn">
      Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙŠ
    </button>
  </div>

  <script>
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ SweetAlert
    function showAlert(msg, type="success") {
      Swal.fire({
        icon: type,
        title: type === "success" ? "Ù†Ø¬Ø§Ø­" : "Ø®Ø·Ø£",
        text: msg,
        confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹"
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const baseUrl = "http://localhost:5000";
      const studentId = localStorage.getItem('studentId');
      const chapter = localStorage.getItem('chapter');
      const level = localStorage.getItem('level');

      if (!studentId || !chapter || !level) {
        showAlert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'error');
        return;
      }

      document.getElementById("addEditForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const page = parseInt(document.getElementById("page_number").value);
        const questionNumber = parseInt(document.getElementById("question_number").value);
        const bookName = document.getElementById("book_name").value.trim();

        if (!page || !questionNumber || !bookName) {
          showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
          return;
        }

        const problem = {
          book: bookName,
          page: page,
          numberOfProblem: questionNumber,
          level: parseInt(level),
          chapter: parseInt(chapter)
        };

        fetch(`${baseUrl}/api/problems`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(problem),
        })
        .then(response => { if(!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø©"); return response.json(); })
        .then(data => {
          showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨.');
          fetchQuestions();
          document.getElementById("addEditForm").reset();
        })
        .catch(error => {
          console.error(error);
          const oldProblem = {
            studentId: studentId,
            chapterIndex: parseInt(chapter),
            levelIndex: parseInt(level),
            book: bookName,
            page: page,
            numberOfQuestion: questionNumber
          };
          fetch(`${baseUrl}/api/Students/add-problem`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(oldProblem),
          })
          .then(response => { if(!response.ok) throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø©"); return response.json(); })
          .then(data => {
            showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
            fetchQuestions();
            document.getElementById("addEditForm").reset();
          })
          .catch(err => showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message, 'error'));
        });
      });

      function fetchQuestions() {
        fetch(`${baseUrl}/api/Students/${studentId}/problems`)
        .then(response => { if(!response.ok) throw new Error('Network response was not ok'); return response.json(); })
        .then(data => {
          const filteredProblems = (data.problems || []).filter(p => 
            parseInt(p.chapter) === parseInt(chapter) && parseInt(p.level) === parseInt(level)
          );
          filteredProblems.sort((a,b) => a.isSolved === b.isSolved ? 0 : a.isSolved ? 1 : -1);

          const allSolved = filteredProblems.length > 0 && filteredProblems.every(p => p.isSolved);
          if(allSolved && filteredProblems.length > 0){
            const levelCompletionMsg = document.createElement('div');
            levelCompletionMsg.className = 'level-completed';
            levelCompletionMsg.innerHTML = '<strong>âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰!</strong>';
            const questionsTable = document.querySelector("#questionsTable");
            if (questionsTable) {
              const h2 = questionsTable.querySelector("h2");
              if (h2) {
                questionsTable.insertBefore(levelCompletionMsg, h2);
                setTimeout(() => levelCompletionMsg.remove(), 5000);
              }
            }
          }

          renderQuestions(filteredProblems);
        })
        .catch(error => {
          console.error(error);
          fetch(`${baseUrl}/api/Students/problems/${studentId}/${chapter}/${level}`)
          .then(response => { if(!response.ok) throw new Error('Network response was not ok'); return response.json(); })
          .then(data => renderQuestions(data))
          .catch(err => {
            document.querySelector("#questionsList tbody").innerHTML = `
              <tr>
                <td colspan="5" style="color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${err.message}</td>
              </tr>
            `;
          });
        });
      }

      function renderQuestions(questions) {
        const questionsTable = document.querySelector("#questionsList tbody");
        questionsTable.innerHTML = questions?.length ? "" : `<tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©</td></tr>`;

        questions?.forEach(question => {
          const row = document.createElement("tr");
          const isSolved = question.isSolved || false;
          const statusClass = isSolved ? 'solved' : 'remaining';
          const statusText = isSolved ? 'âœ… ØªÙ… Ø§Ù„Ø­Ù„' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø­Ù„';

          row.innerHTML = `
            <td>${question.book || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
            <td>${question.page || '--'}</td>
            <td>${question.numberOfProblem || '--'}</td>
            <td class="status ${statusClass}">${statusText}</td>
            <td class="actions">
              ${!isSolved ? `<button class="solve-btn" data-id="${question.problemId}"><i class="fas fa-check"></i> Ø­Ù„</button>` : '<span style="color: green;">âœ“ ØªÙ… Ø§Ù„Ø­Ù„</span>'}
              <button class="delete" data-id="${question.problemId}"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
            </td>
          `;
          questionsTable.appendChild(row);
        });

        document.querySelectorAll(".solve-btn").forEach(btn => {
          btn.addEventListener("click", function (e) {
            const problemId = e.target.closest('button').getAttribute('data-id');
            Swal.fire({
              title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ',
              icon: 'question',
              showCancelButton: true,
              confirmButtonText: 'Ù†Ø¹Ù…',
              cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then(result => {
              if(result.isConfirmed){
                fetch(`${baseUrl}/api/Students/${studentId}/solve/${problemId}`, {method: 'PUT'})
                .then(res => { if(!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„'); return res.json(); })
                .then(data => {
                  showAlert('ØªÙ… Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
                  if(data.student?.levelCompleted) showAlert('Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰! ğŸ‰');
                  fetchQuestions();
                })
                .catch(err => showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„: ' + err.message, 'error'));
              }
            });
          });
        });

        document.querySelectorAll(".delete").forEach(btn => {
          btn.addEventListener("click", function (e) {
            const problemId = e.target.closest('button').getAttribute('data-id');
            Swal.fire({
              title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Ù†Ø¹Ù…',
              cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then(result => {
              if(result.isConfirmed){
                fetch(`${baseUrl}/api/Students/${studentId}/problem/${problemId}`, {method: 'DELETE'})
                .then(res => { if(!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„'); showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­'); fetchQuestions(); })
                .catch(err => showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error'));
              }
            });
          });
        });
      }

      document.getElementById("finishLevelBtn").addEventListener("click", async function () {
        const result = await Swal.fire({
          title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
          text: "Ø³ÙŠØªÙ… Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù†Ù‡ÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰!',
          cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
        });

        if (!result.isConfirmed) return;

        try {
          const response = await fetch(`${baseUrl}/api/Students/${studentId}/finish-level`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chapter: parseInt(chapter), level: parseInt(level)})
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰');
          }

          const data = await response.json();
          showAlert(data.message || "ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!");
          fetchQuestions();

          if(data.student?.currentLevel) {
            const levelNames = ["Yellow","Green","Red","Black","Blue","Gold","Platinum","Diamond"];
            const newLevelIndex = levelNames.indexOf(data.student.currentLevel);
            if(newLevelIndex > parseInt(level)) {
              Swal.fire({
                title: 'ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ!',
                text: `ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ: ${data.student.currentLevel}`,
                icon: 'success',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
              });
            }
          }

        } catch(err) {
          showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message, 'error');
        }
      });

      fetchQuestions();
    });
  </script>
</body>
</html>
