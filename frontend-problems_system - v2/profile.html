<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="profile.css">
  <title>profile</title>

</head>
<body>
  <h2 style="text-align: center;">بيانات الطالب</h2>
  <div class="form-container">
    <label for="studentName">الاسم:</label>
    <input type="text" id="studentName" readonly />

    <label for="studentCode">الكود:</label>
    <input type="text" id="studentCode" readonly />

    <label for="studentNumber">رقم الطالب:</label>
    <input type="text" id="studentNumber" readonly />

    <label for="guardianNumber">رقم ولي الأمر:</label>
    <input type="text" id="guardianNumber" readonly />

    <label for="studentGroup">المجموعة:</label>
    <input type="text" id="studentGroup" readonly />

    <label for="currentLevel">المستوى الحالي:</label>
    <input type="text" id="currentLevel" readonly />

    <div class="attendance-box">
      <p>عدد مرات الحضور في هذا الاسبوع: <span id="attendanceCount">0</span></p>
    </div>
  
    <div class="absence-streak-box">
      <p>سجل الحضور هذا الأسبوع: <span id="absenceStreak">جاري التحميل...</span></p>
    </div>
    <button onclick="location.href='chapter.html'" class="button">عرض مستويات الطالب</button>
    <button onclick="location.href='questions.html'" class="button">عرض مسائل الباب الحالي</button>
  </div>
    
  <script>
    const baseUrl = 'http://localhost:5000';
    const studentId = localStorage.getItem('studentId') || new URLSearchParams(window.location.search).get("id");
    const thisweekchapter = localStorage.getItem('thisweekchapter');

    function getLevelName(level) {
      const levels = ["Yellow", "Green", "Red", "Black", "Blue", "Gold", "Platinum", "Diamond"];
      localStorage.setItem("theLevel", level); // Save the level index to localStorage
      return levels[level] || "Unknown";
    }
    async function loadStudentData() {
      try {
        const [studentRes, attendanceRes, streakRes, levelRes] = await Promise.all([
          fetch(`${baseUrl}/api/Students/search-id?id=${studentId}`),
          fetch(`${baseUrl}/api/Students/current-week-count/${studentId}`),
          fetch(`${baseUrl}/api/Students/${studentId}/streak`),
          fetch(`${baseUrl}/api/UpdatingLevel/current-level/${studentId}/${thisweekchapter}`)
        ]);

        if (!studentRes.ok || !attendanceRes.ok || !streakRes.ok || !levelRes.ok) {
          throw new Error('فشل تحميل بعض البيانات');
        }

        const studentData = await studentRes.json();
        const attendanceCount = await attendanceRes.json();
        const streakData = await streakRes.json();
        const currentLevel = await levelRes.json();

        // Format the attendance streak
        const attendanceDays = streakData.attendanceStreak || [];
        const streakDisplay = attendanceDays.length > 0 
          ? attendanceDays.join(" → ") 
          : "لا يوجد بيانات حضور";

        // Update the DOM
        document.getElementById("studentName").value = studentData.name || "غير متوفر";
        document.getElementById("studentCode").value = studentData.studentId || "غير متوفر";
        document.getElementById("studentNumber").value = studentData.number || "غير متوفر";
        document.getElementById("guardianNumber").value = studentData.parentNumber || "غير متوفر";
        document.getElementById("studentGroup").value = studentData.group || "غير متوفر";
        document.getElementById("attendanceCount").textContent = attendanceCount;
        document.getElementById("absenceStreak").textContent = streakDisplay;
        document.getElementById("currentLevel").value = getLevelName(currentLevel);
        
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("attendanceCount").textContent = "0";
        document.getElementById("absenceStreak").textContent = "غير متوفر";
        document.getElementById("currentLevel").value = "غير معروف";
        alert("حدث خطأ أثناء تحميل البيانات. الرجاء المحاولة لاحقاً.");
      }
    }

    // Start loading data when page loads
    window.addEventListener('DOMContentLoaded', loadStudentData);
  </script>
</body>
</html>