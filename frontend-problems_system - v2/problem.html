<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assign Questions</title>
    <link rel="stylesheet" href="problem.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  </head>
  <body>
    <div class="container">
      <h2>إضافة المسائل</h2>
      <form id="assignProblemForm">
        <label for="book">الكتاب</label>
        <input type="text" id="book" required />

        <label for="page">الصفحة</label>
        <input type="text" id="page" required />

        <label for="number">رقم المسألة</label>
        <input type="text" id="number" required />

        <label for="chapter">الابواب</label>
        <select id="chapter" required>
          <option value="0">الباب الأول</option>
          <option value="1">الباب الثاني</option>
          <option value="2">الباب الثالث</option>
          <option value="3">الباب الرابع</option>
          <option value="4">الحديثه</option>
          <option value="5">الباب الثامن</option>
          <option value="6">كيرشوف</option>
        </select>

        <label for="level">المستوي</label>
        <select id="level" >
          <option value="0">Yellow</option>
          <option value="1">Green</option>
          <option value="2">Red</option>
          <option value="3">Black</option>
          <option value="4">Blue</option>
          <option value="5">Gold</option>
          <option value="6">Platinum</option>
          <option value="7">Diamond</option>
        </select>

        <button type="submit">إضافة المسألة</button>
      </form>

      <h2>المسائل الموجوده</h2>
      <table id="problemsTable">
        <thead>
          <tr>
            <th>الكتاب</th>
            <th>الصفحة</th>
            <th>رقم المسألة</th>
            <th>الباب</th>
            <th>المستوي</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody>
          <!-- Problems will be loaded here -->
        </tbody>
      </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
      const form = document.getElementById("assignProblemForm");
      const problemsTable = document.querySelector("#problemsTable tbody");

      // Toast function
      function showToast(msg, type="success") {
        const bgColor = type === "success" ? "#28a745" : "#dc3545";
        Toastify({
          text: msg,
          duration: 3000,
          gravity: "top",
          position: "center",
          backgroundColor: bgColor,
          stopOnFocus: true,
        }).showToast();
      }

      // Load problems when page loads
      document.addEventListener("DOMContentLoaded", () => {
        const savedChapter = localStorage.getItem("selectedChapter");
        const savedLevel = localStorage.getItem("selectedLevel");
        if (savedChapter !== null) document.getElementById("chapter").value = savedChapter;
        if (savedLevel !== null) document.getElementById("level").value = savedLevel;
        loadProblems();
      });

      // Reload problems when chapter or level changes
      document.getElementById("chapter").addEventListener("change", () => {
        localStorage.setItem("selectedChapter", document.getElementById("chapter").value);
        loadProblems();
      });
      document.getElementById("level").addEventListener("change", () => {
        localStorage.setItem("selectedLevel", document.getElementById("level").value);
        loadProblems();
      });

      function loadProblems() {
        const chapter = parseInt(document.getElementById("chapter").value) || 0;
        const level = parseInt(document.getElementById("level").value) || 0;

        problemsTable.innerHTML = `<tr><td colspan="6">جاري التحميل...</td></tr>`;

        fetch(`http://localhost:5000/api/Problem/all/${chapter}/${level}`)
          .then((response) => {
            if (!response.ok) {
              if (response.status === 404) return [];
              return response.json().then(err => {
                throw new Error(err.error || `HTTP ${response.status}: Failed to load problems`);
              }).catch(() => {
                throw new Error(`HTTP ${response.status}: Failed to load problems`);
              });
            }
            return response.json();
          })
          .then((problems) => {
            problemsTable.innerHTML = "";
            if (!problems || problems.length === 0) {
              problemsTable.innerHTML = `<tr><td colspan="6">لا توجد مسائل متاحة للباب ${chapter} والمستوى ${level}</td></tr>`;
              return;
            }
            problems.forEach((problem) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${problem.book || 'غير محدد'}</td>
                <td>${problem.page || '--'}</td>
                <td>${problem.numberOfProblem || '--'}</td>
                <td>${getChapterName(problem.chapter)}</td>
                <td>${getLevelName(problem.level)}</td>
                <td><button class="delete-btn" 
                    data-id="${problem.problemId}"
                    data-book="${problem.book}"
                    data-page="${problem.page}"
                    data-number="${problem.numberOfProblem}"
                    data-chapter="${problem.chapter}"
                    data-level="${problem.level}">Delete</button></td>
              `;
              problemsTable.appendChild(row);
            });

            document.querySelectorAll(".delete-btn").forEach((btn) => {
              btn.addEventListener("click", function () {
                const problemId = this.getAttribute("data-id");
                deleteProblem(problemId);
              });
            });
          })
          .catch((error) => {
            problemsTable.innerHTML = `<tr><td colspan="6">خطأ في تحميل المسائل: ${error.message || 'Unknown error'}</td></tr>`;
            showToast("خطأ في تحميل المسائل: " + error.message, "error");
          });
      }

      function deleteProblem(problemId) {
        if (!confirm("هل انت متأكد من مسح المسألة؟")) return;

        const button = document.querySelector(`button[data-id="${problemId}"]`);
        const book = button.getAttribute('data-book');
        const page = parseInt(button.getAttribute('data-page'));
        const numberOfProblem = parseInt(button.getAttribute('data-number'));
        const chapter = parseInt(button.getAttribute('data-chapter'));
        const level = parseInt(button.getAttribute('data-level'));

        const data = { book, page, numberOfProblem, chapter, level };

        fetch("http://localhost:5000/api/Problem/remove", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        })
        .then((response) => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || err.error || "لم يتم مسح المسألة"); })
                   .catch(jsonError => { if (jsonError.message) throw jsonError; throw new Error(`HTTP ${response.status}: لم يتم مسح المسألة`); });
          }
          return response.json();
        })
        .then((result) => {
          loadProblems();
          showToast(result.message || "تم مسح المسألة من جميع الطلاب", "success");
        })
        .catch((error) => {
          showToast("لم يتم مسح المسألة: " + error.message, "error");
        });
      }

      function getChapterName(index) {
        const chapters = ["Ch1","Ch2","Ch3","Ch4","ModernPhysics","Ch8","Kirchhoff"];
        return chapters[index] || "Unknown";
      }

      function getLevelName(index) {
        const levels = ["Yellow","Green","Red","Black","Blue","Gold","Platinum","Diamond"];
        return levels[index] || "Unknown";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const problem = {
          book: document.getElementById("book").value,
          page: parseInt(document.getElementById("page").value),
          numberOfProblem: parseInt(document.getElementById("number").value),
          level: parseInt(document.getElementById("level").value),
          chapter: parseInt(document.getElementById("chapter").value),
        };

        try {
          let response = await fetch("http://localhost:5000/api/problems", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(problem),
          });

          if (!response.ok) {
            response = await fetch("http://localhost:5000/api/Problem/assign", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(problem),
            });
          }

          if (!response.ok) throw new Error("Failed to assign problem");
          
          loadProblems();
          showToast("تم إضافة المسألة بنجاح", "success");
        } catch (error) {
          showToast("حدث خطأ في إضافة المسألة: " + error.message, "error");
        }
      });
    </script>
  </body>
</html>
